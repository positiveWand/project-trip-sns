# 관광지 조회 최적화

## 배경
- 관광지 검색 및 조회는 서비스의 핵심 기능
- 관광지 검색 및 조회는 매우 빈번히 발생
  - 사용자가 검색 조건을 바꿀 때마다
  - 사용자가 지도를 옮길 때마다

## 문제
- Postman을 이용한 부하 테스트 진행
  - **테스트용 관광지 데이터 100만 개** 삽입
  - 테스트 파라미터
    - **가상 사용자**: 100명
    - **부하 지속 시간**: 3분
- 매우 좋지 않은 테스트 결과
  - **실패율**: 50%
  - **평균 응답 시간**: 30s

## 문제 원인 파악
- 테스트 중 발생하는 오류는 크게 2가지
  1. **DB Connection 대기 타임아웃**
     - DB 연산이 오래 걸리면서 DB 커넥션을 반환하지 않아 대기하고 있던 요청들에서 timeout 발생
  2. **소켓 타임아웃**
     - DB 연산이 오래 걸리면서 웹 서버 커넥션을 반환하지 않아 연쇄적으로 timeout 발생
- **DB 조회 성능을 올리면 오류는 해결**될 것으로 판단했습니다
- 관광지 조회의 문제점
  - JPA LAZY 로딩으로 인한 N+1 문제
    - 관광지와 일대다 관계에 있는 관광지 분류태그를 조회하면서 N개의 쿼리가 추가 발생
  - 느린 관광지 조회 쿼리
    - 쿼리 프로파일링 기능을 이용해 병목 지점 파악
    - 병목 지점
      - LIKE와 와일드카드를 이용한 문자열(관광지 이름) 검색
      - 위경도 좌표 범위를 이용한 검색

## 문제 해결
### `@BatchSize`를 이용한 배치 조회
- 연관관계에 있는 엔티티 컬렉션 조회 시 Batch로 조회
- 관광지의 개수에 비례해 발생하던 쿼리를 Batch 크기만큼 줄일 수 있음

### 데이터베이스 인덱스
- FULLTEXT INDEX를 이용한 문자열 검색
  - LIKE와 와일드카드를 이용한 문자열 검색은 테이블 full-scan이 발생할 확률이 높음
  - FULLTEXT INDEX를 이용해 토큰 포함 여부를 빠르게 검색
- B-Tree 인덱스
  - 범위 검색 시 인덱스의 도움을 받을 수 있음(B-Tree 계열 인덱스는 정렬되어 있음)
  - 위경도 좌표 범위를 이용한 검색 시 빠르게 검색 가능
  - 위도, 경도 별로 인덱스 적용

### 해결 결과
- **실패율**: 0%
- **평균 응답 시간**: 87ms

## 참조